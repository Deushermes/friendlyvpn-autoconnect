<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN –¥–ª—è iOS</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 15px;
        }
        .step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
        }
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        .btn:hover {
            background: #0056CC;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #34C759;
        }
        .btn-secondary:hover {
            background: #28A745;
        }
        .btn-danger {
            background: #FF3B30;
        }
        .btn-danger:hover {
            background: #D70015;
        }
        .subscription-url {
            background: #f0f0f0;
            border: 1px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 15px 0;
            display: none;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 11px;
            text-align: left;
            display: none;
        }
        .toggle-debug {
            font-size: 12px;
            color: #6c757d;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üì±</div>
        <h1>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN –¥–ª—è iOS</h1>
        
        <div id="status" class="status info">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
        </div>

        <div class="step">
            <strong>1Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Streisand</strong><br>
            <small>–°–∫–∞—á–∞–π—Ç–µ –∏–∑ App Store, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</small>
        </div>

        <button class="btn" onclick="downloadApp()">
            üì≤ –°–∫–∞—á–∞—Ç—å Streisand
        </button>

        <div class="step">
            <strong>2Ô∏è‚É£ –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</strong><br>
            <small>–ü–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å Streisand –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
        </div>

        <button class="btn btn-secondary" onclick="autoConnect()" id="autoConnectBtn" disabled>
            üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        </button>

        <div class="step">
            <strong>3Ô∏è‚É£ –†—É—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</strong><br>
            <small>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ Streisand</small>
        </div>

        <button class="btn" onclick="copyUrl()" id="copyBtn" disabled>
            üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
        </button>

        <button class="btn btn-danger" onclick="showUrl()" id="showUrlBtn" disabled>
            üëÅ –ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É
        </button>

        <div id="subscription-url" class="subscription-url"></div>

        <div class="step">
            <small>
                <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong><br>
                1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Streisand<br>
                2. –ù–∞–∂–º–∏—Ç–µ "+" (–ø–ª—é—Å) –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É<br>
                3. –í—ã–±–µ—Ä–∏—Ç–µ "Import from Clipboard"<br>
                4. –ù–∞–∂–º–∏—Ç–µ "Connect" –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            </small>
        </div>

        <span class="toggle-debug" onclick="toggleDebug()">üîß –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</span>
        <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
        let subscriptionUrl = null;
        let debugMode = false;

        // –ü–æ–ª—É—á–∞–µ–º URL –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            subscriptionUrl = urlParams.get('url');
            
            logDebug('URL Parameters:', window.location.search);
            logDebug('Subscription URL:', subscriptionUrl);
            
            if (subscriptionUrl) {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º URL –µ—Å–ª–∏ –æ–Ω –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω
                try {
                    subscriptionUrl = decodeURIComponent(subscriptionUrl);
                    logDebug('Decoded URL:', subscriptionUrl);
                } catch (e) {
                    logDebug('URL decode error:', e.message);
                }
                
                document.getElementById('subscription-url').textContent = subscriptionUrl;
                document.getElementById('status').innerHTML = '‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é';
                document.getElementById('status').className = 'status success';
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('autoConnectBtn').disabled = false;
                document.getElementById('copyBtn').disabled = false;
                document.getElementById('showUrlBtn').disabled = false;
                
            } else {
                document.getElementById('status').innerHTML = '‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ URL';
                document.getElementById('status').className = 'status error';
                logDebug('Error: No subscription URL in parameters');
            }
        }

        function logDebug(title, content = '') {
            if (!debugMode) return;
            const debugEl = document.getElementById('debug-info');
            debugEl.innerHTML += `<strong>${title}</strong><br>${content}<br><br>`;
            console.log(title, content);
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugEl = document.getElementById('debug-info');
            debugEl.style.display = debugMode ? 'block' : 'none';
            
            if (debugMode) {
                logDebug('Debug mode enabled');
                logDebug('User Agent:', navigator.userAgent);
                logDebug('Current URL:', window.location.href);
                logDebug('Subscription URL Length:', subscriptionUrl ? subscriptionUrl.length : 'null');
            }
        }

        function downloadApp() {
            logDebug('Opening App Store...');
            window.open('https://apps.apple.com/ru/app/streisand/id6450534064', '_blank');
        }

        function autoConnect() {
            if (!subscriptionUrl) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏');
                return;
            }

            try {
                logDebug('Starting auto-connect...');
                logDebug('Original subscription URL:', subscriptionUrl);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ VLESS —Å—Å—ã–ª–∫–∞
                if (!subscriptionUrl.startsWith('vless://')) {
                    logDebug('Warning: URL does not start with vless://');
                }
                
                // –†–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã URL schemes –¥–ª—è Streisand
                const schemes = [
                    // –ü—Ä—è–º–∞—è VLESS —Å—Å—ã–ª–∫–∞ (–¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å)
                    subscriptionUrl,
                    
                    // Streisand schemes —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
                    `streisand://import/${encodeURIComponent(subscriptionUrl)}`,
                    `streisand://add?url=${encodeURIComponent(subscriptionUrl)}`,
                    `streisand://config?url=${encodeURIComponent(subscriptionUrl)}`,
                    `streisand://import?config=${encodeURIComponent(subscriptionUrl)}`,
                    
                    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã –¥–ª—è V2Ray –∫–ª–∏–µ–Ω—Ç–æ–≤
                    `v2ray://import/${encodeURIComponent(subscriptionUrl)}`,
                    `clash://install-config?url=${encodeURIComponent(subscriptionUrl)}`,
                ];

                let currentScheme = 0;
                let attemptStartTime = Date.now();
                
                function tryNextScheme() {
                    if (currentScheme < schemes.length) {
                        const url = schemes[currentScheme];
                        const schemeName = currentScheme === 0 ? 'Direct VLESS' : 
                                          url.includes('streisand://') ? 'Streisand scheme' :
                                          url.includes('v2ray://') ? 'V2Ray scheme' : 'Other';
                        
                        logDebug(`Attempt ${currentScheme + 1} (${schemeName}):`, url);
                        
                        document.getElementById('status').innerHTML = `üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${currentScheme + 1}/${schemes.length}: ${schemeName}`;
                        document.getElementById('status').className = 'status info';
                        
                        // –°–æ–∑–¥–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—É—é —Å—Å—ã–ª–∫—É –∏ –∫–ª–∏–∫–∞–µ–º –ø–æ –Ω–µ–π
                        const link = document.createElement('a');
                        link.href = url;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        
                        try {
                            link.click();
                            logDebug('Link clicked successfully');
                        } catch (clickError) {
                            logDebug('Click error:', clickError.message);
                            // Fallback: –ø—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ location
                            window.location.href = url;
                        }
                        
                        document.body.removeChild(link);
                        currentScheme++;
                        
                        // –ß–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–ø–æ—Å–æ–±
                        setTimeout(() => {
                            if (currentScheme < schemes.length) {
                                tryNextScheme();
                            } else {
                                // –í—Å–µ —Å–ø–æ—Å–æ–±—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã
                                const totalTime = Math.round((Date.now() - attemptStartTime) / 1000);
                                logDebug(`All schemes exhausted after ${totalTime}s`);
                                
                                document.getElementById('status').innerHTML = 
                                    '‚ùå –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ.<br>' +
                                    '<small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–∏–∂–µ</small>';
                                document.getElementById('status').className = 'status error';
                                showUrl();
                            }
                        }, 4000);
                    }
                }
                
                tryNextScheme();

            } catch (error) {
                logDebug('AutoConnect error:', error.message);
                document.getElementById('status').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                document.getElementById('status').className = 'status error';
            }
        }

        function copyUrl() {
            if (!subscriptionUrl) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏');
                return;
            }

            logDebug('Copying URL to clipboard...');
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(subscriptionUrl).then(() => {
                    alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å:\n1. –û—Ç–∫—Ä–æ–π—Ç–µ Streisand\n2. –ù–∞–∂–º–∏—Ç–µ "+"\n3. –í—ã–±–µ—Ä–∏—Ç–µ "Import from Clipboard"');
                    showUrl();
                }).catch((error) => {
                    logDebug('Clipboard error:', error.message);
                    showUrl();
                    alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ –ø–æ–ª—è –Ω–∏–∂–µ –≤—Ä—É—á–Ω—É—é');
                });
            } else {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                showUrl();
                alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ –ø–æ–ª—è –Ω–∏–∂–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Streisand');
            }
        }

        function showUrl() {
            document.getElementById('subscription-url').style.display = 'block';
            logDebug('Showing subscription URL');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                logDebug('Page restored from cache');
                document.getElementById('status').innerHTML = 'üîÑ –í–µ—Ä–Ω—É–ª–∏—Å—å –≤ –±—Ä–∞—É–∑–µ—Ä. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Streisand –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä—É—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
                document.getElementById('status').className = 'status info';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞/—Ä–∞–∑–º—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        let pageVisible = true;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                pageVisible = false;
                logDebug('Page hidden - possibly switched to Streisand');
            } else {
                if (!pageVisible) {
                    logDebug('Page visible again - returned from app');
                    document.getElementById('status').innerHTML = 'üîÑ –ï—Å–ª–∏ Streisand –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä—É—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
                    document.getElementById('status').className = 'status info';
                }
                pageVisible = true;
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
